================================================================================
INTEGRATION GUIDE: MATERIAL CALCULATIONS TO USERS & PROCUREMENT
================================================================================

PART 1: BACKEND CALCULATION FLOW (FILE 3C)
================================================================================

DATABASE FUNCTION: calculate_material_requirements(quote_id)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

INPUT:
  - quote_id (UUID of the quote)

OUTPUT FIELDS:
  - product_sku
  - product_description
  - application_type
  - r_value
  - base_area_sqm (area entered by VA)
  - waste_percent (default 10%)
  - total_area_with_waste (calculated)
  - bale_size_sqm (from product table)
  - packs_required (CEIL calculation - industry standard)
  - total_sqm_provided (packs Ã— bale_size)
  - excess_sqm (buffer material)
  - retail_price_per_unit ($/mÂ²)
  - pack_price ($/pack)
  - total_pack_cost (packs Ã— pack_price)
  - current_stock_packs (inventory check)
  - stock_shortfall_packs (ordering trigger)

EXAMPLE QUERY:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

SELECT * FROM calculate_material_requirements('quote-uuid-here');

RESULT:
â”€â”€â”€â”€â”€â”€â”€

| sku     | product_description              | application_type | r_value   | base_area_sqm | waste_percent | total_area_with_waste | bale_size_sqm | packs_required | total_sqm_provided | excess_sqm | retail_price_per_unit | pack_price | total_pack_cost | current_stock_packs | stock_shortfall_packs |
|---------|----------------------------------|------------------|-----------|---------------|---------------|-----------------------|---------------|----------------|--------------------|------------|------------------------|------------|-----------------|---------------------|-----------------------|
| PIL-006 | Premier Glasswool R2.4 90mm     | Wall, Mid-Floor  | R2.4 90mm | 100.00        | 10.00         | 110.00                | 12.00         | 10             | 120.00             | 10.00      | 6.21                   | 74.50      | 745.00          | 4.17                | 6                     |

================================================================================
PART 2: REACT COMPONENT - QUOTE VIEW INTEGRATION
================================================================================

WHERE TO DISPLAY:
  - Quote summary page
  - After customer adds quote items (sections + products)
  - "Materials & Costs" tab or section

COMPONENTS NEEDED:

1. API CALL (in useEffect when quote loads):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const [materialRequirements, setMaterialRequirements] = useState([]);
const [loadingCalc, setLoadingCalc] = useState(false);

useEffect(() => {
  if (quoteId) {
    fetchMaterialRequirements(quoteId);
  }
}, [quoteId]);

const fetchMaterialRequirements = async (qId) => {
  setLoadingCalc(true);
  try {
    const { data, error } = await supabase
      .rpc('calculate_material_requirements', { p_quote_id: qId });
    
    if (error) throw error;
    setMaterialRequirements(data);
  } catch (error) {
    console.error('Error fetching material requirements:', error);
  } finally {
    setLoadingCalc(false);
  }
};

2. DISPLAY COMPONENT:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

MaterialRequirementsSummary.jsx

Features:
  âœ“ Shows each product with area, waste, packs required
  âœ“ Displays total costs
  âœ“ Highlights stock shortfalls (red warning)
  âœ“ "Generate Procurement Order" button
  âœ“ Export to PDF (quote includes material breakdown)

3. EXAMPLE TABLE VIEW:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MATERIAL REQUIREMENTS SUMMARY                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Product      â”‚ R-Value  â”‚ Area (mÂ²)â”‚ +Waste   â”‚ Packs    â”‚ Cost     â”‚ Stock  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PIL-006      â”‚ R2.4 90mmâ”‚ 100.00   â”‚ 110.00   â”‚ 10       â”‚ $745.00  â”‚ âš ï¸ -6  â”‚
â”‚ PIL-015      â”‚ R2.7 120mâ”‚  80.00   â”‚  88.00   â”‚  8       â”‚ $456.00  â”‚ âœ“  OK  â”‚
â”‚ PIL-069      â”‚ Acoustic â”‚  20.00   â”‚  22.00   â”‚  2       â”‚ $318.00  â”‚ âœ“  OK  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          TOTAL COST    â”‚ $1,519.00           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STOCK ALERTS:
  ğŸ”´ PIL-006: Stock shortage of 6 packs (60mÂ²) - needs immediate order
  ğŸŸ¡ PIL-015: Low stock - consider reordering
  ğŸŸ¢ PIL-069: Adequate stock

================================================================================
PART 3: PROCUREMENT ORDER GENERATION
================================================================================

WHEN USER CLICKS "GENERATE PROCUREMENT ORDER":

1. GATHER DATA:
   - All products from material_requirements
   - Packs required for each
   - Stock shortfall amounts
   - Existing purchase orders (to avoid duplicates)
   - Supplier info (from product_id â†’ supplier_id)

2. CREATE PROCUREMENT ORDER:
   - Generate order reference (e.g., PO-2025-1123-001)
   - Group by supplier
   - Mark as "PENDING" status
   - Link to quote for traceability
   - Set expected delivery date (+14 days default)

3. SEND NOTIFICATION:
   - Alert procurement team
   - Email with order summary
   - Link to GHL for follow-up

4. TRACK IN SYSTEM:
   - Monitor in Inventory module
   - Update stock when received
   - Auto-update quote status when stock available

PROCUREMENT ORDER TABLE STRUCTURE:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

purchase_orders:
  - po_number (unique)
  - supplier_id (link to suppliers table)
  - quote_id (link to quote for reference)
  - order_date
  - expected_delivery_date
  - actual_delivery_date
  - status (PENDING, ORDERED, RECEIVED, DELAYED)
  - subtotal
  - gst_amount (15% for NZ)
  - total_amount
  - notes

purchase_order_items:
  - po_id
  - product_id
  - quantity (in packs)
  - unit_price (pack_price)
  - line_total

================================================================================
PART 4: STANDALONE CALCULATOR (InsulationCalculator.jsx)
================================================================================

FEATURES:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ“ Product search (by SKU, description, R-value, application)
âœ“ Area input with waste factor (default 10%)
âœ“ Real-time calculations
âœ“ Pack requirements display
âœ“ Buffer material visualization
âœ“ Pricing breakdown
âœ“ Procurement summary
âœ“ Can be used offline (no quote needed)

LOCATION IN APP:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

- Help Menu â†’ "Insulation Calculator"
- Or: Dashboard â†’ Quick Tools â†’ Insulation Calculator
- Or: Embedded in quote creation wizard

INTEGRATION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// In App.jsx or navigation
import InsulationCalculator from '@/components/InsulationCalculator';

<Route path="/help/calculator" element={<InsulationCalculator />} />

// Or as modal
<Modal title="Insulation Calculator" open={showCalc}>
  <InsulationCalculator />
</Modal>

================================================================================
PART 5: DATA FLOW DIAGRAM
================================================================================

VA Creates Quote
       â†“
VA Adds Quote Sections & Products
       â†“
System Calls: calculate_material_requirements(quote_id)
       â†“
Returns: Area, Waste, Packs, Cost, Stock Status
       â†“
Display in Quote: "Materials & Costs" Tab
       â†“
Stock Check:
  - In Stock? âœ“ Quote ready
  - Stock Low? âš ï¸ Alert
  - Out of Stock? âŒ Block/Alert
       â†“
User Clicks: "Generate Procurement Order"
       â†“
System Creates PO:
  - Groups products by supplier
  - Calculates totals
  - Links to quote
       â†“
Notifies Procurement Team
       â†“
PO Status Tracked
       â†“
When Stock Received â†’ Auto-update inventory
       â†“
Quote Status Updates (if was blocked)

================================================================================
PART 6: API ENDPOINTS NEEDED (For Frontend)
================================================================================

1. GET MATERIAL REQUIREMENTS:
   POST /api/quotes/{quoteId}/material-requirements
   
   Response:
   {
     success: true,
     data: [
       {
         productSku: "PIL-006",
         productDescription: "Premier Glasswool R2.4 90mm",
         applicationType: "Wall, Mid-Floor",
         rValue: "R2.4 90mm",
         baseAreaSqm: 100.00,
         wastePercent: 10.00,
         totalAreaWithWaste: 110.00,
         baleSize: 12.00,
         packsRequired: 10,
         totalSqmProvided: 120.00,
         excessSqm: 10.00,
         retailPricePerUnit: 6.21,
         packPrice: 74.50,
         totalPackCost: 745.00,
         currentStockPacks: 4.17,
         stockShortfallPacks: 6
       }
     ]
   }

2. GENERATE PROCUREMENT ORDER:
   POST /api/procurement/generate-order
   
   Body:
   {
     quoteId: "uuid",
     products: [
       {
         productId: "uuid",
         packsRequired: 10,
         supplierId: "uuid"
       }
     ]
   }
   
   Response:
   {
     success: true,
     poNumber: "PO-2025-1123-001",
     purchaseOrderId: "uuid",
     totalAmount: 1519.00,
     items: 3,
     status: "PENDING"
   }

================================================================================
PART 7: USER WORKFLOWS
================================================================================

WORKFLOW 1: VA Creating Quote (with auto-calculations)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. VA selects client
2. VA adds sections (Ceiling, Walls, etc)
3. VA selects products and areas
   â†’ System auto-calculates material requirements
   â†’ Shows "Need 10 packs of PIL-006 ($745)"
   â†’ Shows stock status: "6 packs short"
4. VA reviews quote
5. VA can:
   a) Approve quote as-is (note: needs stock)
   b) Adjust areas (recalculates)
   c) Generate procurement order (auto-orders shortage)
6. System notifies procurement team

WORKFLOW 2: Using Calculator for Quick Estimates
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. User clicks "Help" â†’ "Insulation Calculator"
2. Searches product (e.g., "R2.4 ceiling")
3. Enters area (e.g., 150 mÂ²)
4. Adjusts waste % if needed
5. Clicks "Calculate"
6. Sees: "Need 13 packs ($975), Buffer: 6 mÂ²"
7. Can copy results to email/document
8. OR: "Add to Quote" button (if logged in)

WORKFLOW 3: Procurement Order Placement
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Quote shows material requirements
2. Procurement check: "Stock shortfall: 6 packs PIL-006"
3. Click "Generate Order" button
4. System groups by supplier
5. Shows preview: "Order 6 packs from Supplier A"
6. Click "Confirm Order"
7. System creates PO, sends to supplier email
8. Tracks delivery
9. When stock received â†’ auto-update inventory

================================================================================
